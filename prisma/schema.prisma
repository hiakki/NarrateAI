generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  OWNER
  ADMIN
  USER
}

enum UserPlan {
  FREE
  STARTER
  PRO
  AGENCY
}

enum SeriesStatus {
  ACTIVE
  PAUSED
}

enum VideoStatus {
  QUEUED
  GENERATING
  READY
  SCHEDULED
  POSTED
  FAILED
}

enum GenerationStage {
  SCRIPT
  TTS
  IMAGES
  ASSEMBLY
  UPLOADING
}

enum Platform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum LlmProvider {
  GEMINI_FLASH
  OPENAI_GPT4O_MINI
  DEEPSEEK_V3
  QWEN
}

enum TtsProvider {
  GEMINI_TTS
  ELEVENLABS
  COSYVOICE
  FISH_AUDIO
  EDGE_TTS
}

enum ImageProvider {
  GEMINI_IMAGEN
  DALLE3
  FLUX
  KOLORS
  SDXL
  FLUX_SCHNELL
  TOGETHER
  SILICONFLOW
  LEONARDO
  IDEOGRAM
}

// ─── Models ──────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  avatarUrl     String?
  role          UserRole  @default(USER)
  plan          UserPlan  @default(FREE)
  stripeCustomerId String?

  defaultLlmProvider   LlmProvider?
  defaultTtsProvider   TtsProvider?
  defaultImageProvider ImageProvider?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  series         Series[]
  socialAccounts SocialAccount[]
  subscription   Subscription?

  @@map("users")
}

model Series {
  id              String       @id @default(cuid())
  userId          String
  name            String
  niche           String
  artStyle        String       @default("realistic")
  musicType       String?
  musicUrl        String?
  voiceId         String?
  language        String       @default("en")
  tone            String       @default("dramatic")
  targetPlatforms Json         @default("[]")
  postingSchedule Json?
  status          SeriesStatus @default(ACTIVE)

  llmProvider     LlmProvider?
  ttsProvider     TtsProvider?
  imageProvider   ImageProvider?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  videos          Video[]

  @@index([userId])
  @@map("series")
}

model Video {
  id               String           @id @default(cuid())
  seriesId         String
  title            String?
  description      String?
  scriptText       String?
  scenesJson       Json?
  voiceoverUrl     String?
  videoUrl         String?
  thumbnailUrl     String?
  duration         Int?
  targetDuration   Int?
  status           VideoStatus      @default(QUEUED)
  generationStage  GenerationStage?
  scheduledPostTime DateTime?
  postedPlatforms  Json             @default("[]")
  errorMessage     String?
  checkpointData   Json?

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  series           Series           @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@index([seriesId])
  @@index([status])
  @@map("videos")
}

model SocialAccount {
  id              String   @id @default(cuid())
  userId          String
  platform        Platform
  platformUserId  String
  accessTokenEnc  String
  refreshTokenEnc String?
  username        String?
  profileUrl      String?
  connectedAt     DateTime @default(now())
  tokenExpiresAt  DateTime?

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, platformUserId])
  @@index([userId])
  @@map("social_accounts")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeSubscriptionId String             @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}
